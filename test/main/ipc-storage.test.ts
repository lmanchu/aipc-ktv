import { describe, it, expect, vi, beforeEach } from 'vitest'\nimport { ipcMain, app } from 'electron'\nimport { getStorageService, StorageService } from '../../src/main/storage'\nimport path from 'node:path'\nimport fs from 'node:fs/promises'\n\n// Mock Electron's app.getPath to control the userData path for testing\nvi.mock('electron', async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    app: {\n      ...actual.app,\n      getPath: vi.fn((name) => {\n        if (name === 'userData') {\n          return path.join(process.cwd(), 'test-user-data')\n        }\n        return actual.app.getPath(name)\n      }),\n    },\n    ipcMain: {\n      handle: vi.fn(),\n      on: vi.fn(),\n      removeHandler: vi.fn(),\n    },\n  }\n})\n\n// Mock the StorageService methods to isolate IPC handler tests\nvi.mock('../../src/main/storage', () => {\n  const mockStorageService = {\n    read: vi.fn(),\n    write: vi.fn(),\n    exists: vi.fn(),\n    delete: vi.fn(),\n    ensureDirectory: vi.fn(),\n    getUserDataPath: vi.fn(() => path.join(process.cwd(), 'test-user-data'))\n  }\n  return {\n    getStorageService: vi.fn(() => mockStorageService),\n    StorageService: vi.fn(() => mockStorageService),\n  }\n})\n\ndescribe('IPC Storage Handlers', () => {\n  let mockStorageService: StorageService\n\n  beforeEach(() => {\n    // Clear all mocks before each test\n    vi.clearAllMocks()\n    // Ensure the mock storage service is returned\n    mockStorageService = getStorageService() as unknown as StorageService\n\n    // Dynamically import src/main/index.ts to register IPC handlers\n    // This ensures that ipcMain.handle calls within index.ts are captured by our mock\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    require('../../src/main/index.ts')\n  })\n\n  it('should register storage-read handler', () => {\n    expect(ipcMain.handle).toHaveBeenCalledWith('storage-read', expect.any(Function))\n  })\n\n  it('should register storage-write handler', () => {\n    expect(ipcMain.handle).toHaveBeenCalledWith('storage-write', expect.any(Function))\n  })\n\n  it('should register storage-exists handler', () => {\n    expect(ipcMain.handle).toHaveBeenCalledWith('storage-exists', expect.any(Function))\n  })\n\n  it('should register storage-delete handler', () => {\n    expect(ipcMain.handle).toHaveBeenCalledWith('storage-delete', expect.any(Function))\n  })\n\n  it('should register storage-ensure-directory handler', () => {\n    expect(ipcMain.handle).toHaveBeenCalledWith('storage-ensure-directory', expect.any(Function))\n  })\n\n  describe('storage-read', () => {\n    it('should call storageService.read and return data', async () => {\n      const mockData = { key: 'value' }\n      vi.spyOn(mockStorageService, 'read').mockResolvedValue(mockData)\n\n      // Find the handler function that was registered with 'storage-read'\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-read'\n      )?.[1]\n      expect(handler).toBeDefined()\n\n      const result = await handler(null, 'testfile.json')\n      expect(mockStorageService.read).toHaveBeenCalledWith('testfile.json')\n      expect(result).toEqual({ success: true, data: mockData })\n    })\n\n    it('should return null if file not found', async () => {\n      vi.spyOn(mockStorageService, 'read').mockResolvedValue(null)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-read'\n      )?.[1]\n      const result = await handler(null, 'nonexistent.json')\n      expect(mockStorageService.read).toHaveBeenCalledWith('nonexistent.json')\n      expect(result).toEqual({ success: true, data: null })\n    })\n\n    it('should return error if filename is invalid', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-read'\n      )?.[1]\n      const result = await handler(null, 123) // Invalid filename\n      expect(result).toEqual({ success: false, error: 'Invalid filename' })\n      expect(mockStorageService.read).not.toHaveBeenCalled()\n    })\n\n    it('should return error on storageService.read failure', async () => {\n      const errorMessage = 'Read error'\n      vi.spyOn(mockStorageService, 'read').mockRejectedValue(new Error(errorMessage))\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-read'\n      )?.[1]\n      const result = await handler(null, 'errorfile.json')\n      expect(mockStorageService.read).toHaveBeenCalledWith('errorfile.json')\n      expect(result).toEqual({ success: false, error: errorMessage })\n    })\n  })\n\n  describe('storage-write', () => {\n    it('should call storageService.write and return success', async () => {\n      vi.spyOn(mockStorageService, 'write').mockResolvedValue(undefined)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-write'\n      )?.[1]\n      const mockData = { item: 'new' }\n      const result = await handler(null, 'newfile.json', mockData)\n      expect(mockStorageService.write).toHaveBeenCalledWith('newfile.json', mockData)\n      expect(result).toEqual({ success: true })\n    })\n\n    it('should return error if filename is invalid', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-write'\n      )?.[1]\n      const result = await handler(null, null, { data: 'some' }) // Invalid filename\n      expect(result).toEqual({ success: false, error: 'Invalid filename' })\n      expect(mockStorageService.write).not.toHaveBeenCalled()\n    })\n\n    it('should return error if data is undefined', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-write'\n      )?.[1]\n      const result = await handler(null, 'file.json', undefined)\n      expect(result).toEqual({ success: false, error: 'Data cannot be undefined' })\n      expect(mockStorageService.write).not.toHaveBeenCalled()\n    })\n\n    it('should return error on storageService.write failure', async () => {\n      const errorMessage = 'Write error'\n      vi.spyOn(mockStorageService, 'write').mockRejectedValue(new Error(errorMessage))\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-write'\n      )?.[1]\n      const result = await handler(null, 'errorfile.json', { bad: 'data' })\n      expect(mockStorageService.write).toHaveBeenCalledWith('errorfile.json', { bad: 'data' })\n      expect(result).toEqual({ success: false, error: errorMessage })\n    })\n  })\n\n  describe('storage-exists', () => {\n    it('should call storageService.exists and return true', async () => {\n      vi.spyOn(mockStorageService, 'exists').mockResolvedValue(true)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-exists'\n      )?.[1]\n      const result = await handler(null, 'existing.json')\n      expect(mockStorageService.exists).toHaveBeenCalledWith('existing.json')\n      expect(result).toEqual({ success: true, exists: true })\n    })\n\n    it('should call storageService.exists and return false', async () => {\n      vi.spyOn(mockStorageService, 'exists').mockResolvedValue(false)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-exists'\n      )?.[1]\n      const result = await handler(null, 'nonexisting.json')\n      expect(mockStorageService.exists).toHaveBeenCalledWith('nonexisting.json')\n      expect(result).toEqual({ success: true, exists: false })\n    })\n\n    it('should return error if filename is invalid', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-exists'\n      )?.[1]\n      const result = await handler(null, { name: 'file' }) // Invalid filename\n      expect(result).toEqual({ success: false, error: 'Invalid filename' })\n      expect(mockStorageService.exists).not.toHaveBeenCalled()\n    })\n\n    it('should return error on storageService.exists failure', async () => {\n      const errorMessage = 'Exists check error'\n      vi.spyOn(mockStorageService, 'exists').mockRejectedValue(new Error(errorMessage))\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-exists'\n      )?.[1]\n      const result = await handler(null, 'errorcheck.json')\n      expect(mockStorageService.exists).toHaveBeenCalledWith('errorcheck.json')\n      expect(result).toEqual({ success: false, error: errorMessage })\n    })\n  })\n\n  describe('storage-delete', () => {\n    it('should call storageService.delete and return success', async () => {\n      vi.spyOn(mockStorageService, 'delete').mockResolvedValue(undefined)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-delete'\n      )?.[1]\n      const result = await handler(null, 'todelete.json')\n      expect(mockStorageService.delete).toHaveBeenCalledWith('todelete.json')\n      expect(result).toEqual({ success: true })\n    })\n\n    it('should return error if filename is invalid', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-delete'\n      )?.[1]\n      const result = await handler(null, []) // Invalid filename\n      expect(result).toEqual({ success: false, error: 'Invalid filename' })\n      expect(mockStorageService.delete).not.toHaveBeenCalled()\n    })\n\n    it('should return error on storageService.delete failure', async () => {\n      const errorMessage = 'Delete error'\n      vi.spyOn(mockStorageService, 'delete').mockRejectedValue(new Error(errorMessage))\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-delete'\n      )?.[1]\n      const result = await handler(null, 'errordelete.json')\n      expect(mockStorageService.delete).toHaveBeenCalledWith('errordelete.json')\n      expect(result).toEqual({ success: false, error: errorMessage })\n    })\n  })\n\n  describe('storage-ensure-directory', () => {\n    it('should call storageService.ensureDirectory and return success', async () => {\n      vi.spyOn(mockStorageService, 'ensureDirectory').mockResolvedValue(undefined)\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-ensure-directory'\n      )?.[1]\n      const result = await handler(null, 'testdir')\n      expect(mockStorageService.ensureDirectory).toHaveBeenCalledWith('testdir')\n      expect(result).toEqual({ success: true })\n    })\n\n    it('should return error if directory is invalid', async () => {\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-ensure-directory'\n      )?.[1]\n      const result = await handler(null, 123) // Invalid directory\n      expect(result).toEqual({ success: false, error: 'Invalid directory path' })\n      expect(mockStorageService.ensureDirectory).not.toHaveBeenCalled()\n    })\n\n    it('should return error on storageService.ensureDirectory failure', async () => {\n      const errorMessage = 'Directory creation error'\n      vi.spyOn(mockStorageService, 'ensureDirectory').mockRejectedValue(new Error(errorMessage))\n      const handler = (ipcMain.handle as vi.Mock).mock.calls.find(\n        ([channel]) => channel === 'storage-ensure-directory'\n      )?.[1]\n      const result = await handler(null, 'errordir')\n      expect(mockStorageService.ensureDirectory).toHaveBeenCalledWith('errordir')\n      expect(result).toEqual({ success: false, error: errorMessage })\n    })\n  })\n})\n